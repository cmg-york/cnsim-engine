<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileBasedNodeSampler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CNSim Engine</a> &gt; <a href="index.source.html" class="el_package">ca.yorku.cmg.cnsim.engine.sampling.filesamplers</a> &gt; <span class="el_source">FileBasedNodeSampler.java</span></div><h1>FileBasedNodeSampler.java</h1><pre class="source lang-java linenums">package ca.yorku.cmg.cnsim.engine.sampling.filesamplers;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.LinkedList;
import java.util.Queue;

import ca.yorku.cmg.cnsim.engine.Debug;
import ca.yorku.cmg.cnsim.engine.config.Config;
import ca.yorku.cmg.cnsim.engine.sampling.interfaces.AbstractNodeSampler;

/**
 * Node sampler that reads node characteristics from a CSV file.
 * &lt;p&gt;
 * The CSV file is expected to contain the following columns:
 * &lt;ol&gt;
 *   &lt;li&gt;Node ID (ignored)&lt;/li&gt;
 *   &lt;li&gt;Node hash power (float)&lt;/li&gt;
 *   &lt;li&gt;Node electric power (float, Watts)&lt;/li&gt;
 *   &lt;li&gt;Node electricity cost (float, currency per kWh)&lt;/li&gt;
 * &lt;/ol&gt;
 * Optionally, the first line can be a header, which will be skipped.
 * &lt;p&gt;
 * If the file does not contain enough nodes according to the configuration
 * property {@code net.numOfNodes}, additional node samples are drawn from
 * an optional {@linkplain AbstractNodeSampler} passed as the alternative sampler.
 * 
 * @author Sotirios Liaskos
 * @see AbstractNodeSampler
 */
public class FileBasedNodeSampler extends AbstractNodeSampler {

	/** Optional alternative node sampler for additional nodes if the file is too short */
<span class="nc" id="L35">	private AbstractNodeSampler alternativeSampler = null;</span>

	/** Path to the CSV file containing node data */
	private String nodesFilePath;

	/** Queue of node electric power samples (Watts) read from the file */
<span class="nc" id="L41">	private Queue&lt;Float&gt; nodeElectricPowers = new LinkedList&lt;&gt;();</span>

	/** Queue of node hash power samples (hashes/sec) read from the file */
<span class="nc" id="L44">	private Queue&lt;Float&gt; nodeHashPowers = new LinkedList&lt;&gt;();</span>

	/** Queue of node electricity cost samples (currency per kWh) read from the file */
<span class="nc" id="L47">	private Queue&lt;Float&gt; nodeElectricityCosts = new LinkedList&lt;&gt;();</span>

	/** Number of nodes required according to configuration */
<span class="nc" id="L50">	private int requiredNodeLines = Config.getPropertyInt(&quot;net.numOfNodes&quot;);</span>



	// -----------------------------------------------------------------
	// CONSTRUCTORS
	// -----------------------------------------------------------------

	/**
	 * Creates a {@linkplain FileBasedNodeSampler} that reads node data from a file.
	 * 
	 * @param nodesFilePath Path to the CSV file containing node data
	 * @param nodeSampler   Alternative {@linkplain AbstractNodeSampler} for additional nodes if file specifies fewer nodes than required as per configuration
	 */
<span class="nc" id="L64">	public FileBasedNodeSampler(String nodesFilePath, AbstractNodeSampler nodeSampler) {</span>
<span class="nc" id="L65">		this.nodesFilePath = nodesFilePath;</span>
<span class="nc" id="L66">		this.alternativeSampler = nodeSampler;</span>
<span class="nc" id="L67">		loadNodeConfig();</span>
<span class="nc" id="L68">	}</span>

	// -----------------------------------------------------------------
	// FILE LOADING
	// -----------------------------------------------------------------

	/**
	 * Loads node data from the file, assuming the first line is a header.
	 */
	public void loadNodeConfig() {
<span class="nc" id="L78">		loadNodeConfig(true);</span>
<span class="nc" id="L79">	}</span>

	/**
	 * Loads node data from the file, optionally skipping the first line if it is a header.
	 * 
	 * @param hasHeaders True if the first line is a header
	 */
	public void loadNodeConfig(boolean hasHeaders) {
<span class="nc" id="L87">		int lineCount = 0;</span>
<span class="nc" id="L88">		try (BufferedReader br = new BufferedReader(new FileReader(nodesFilePath))) {</span>
			String line;
<span class="nc bnc" id="L90" title="All 2 branches missed.">			while ((line = br.readLine()) != null) {</span>
<span class="nc" id="L91">				lineCount++;</span>
<span class="nc" id="L92">				String[] values = line.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">				if (values.length != 4) {</span>
<span class="nc" id="L94">					continue; // Skip lines that don't have exactly 4 values</span>
				}
<span class="nc bnc" id="L96" title="All 4 branches missed.">				if (hasHeaders &amp;&amp; lineCount == 1) {</span>
<span class="nc" id="L97">					continue; // Skip first line</span>
				}
				try {
<span class="nc" id="L100">					nodeHashPowers.add(Float.parseFloat(values[1].trim()));</span>
<span class="nc" id="L101">					nodeElectricPowers.add(Float.parseFloat(values[2].trim()));</span>
<span class="nc" id="L102">					nodeElectricityCosts.add(Float.parseFloat(values[3].trim()));</span>
<span class="nc" id="L103">				} catch (NumberFormatException e) {</span>
<span class="nc" id="L104">					Debug.e(this,&quot;loadNodeConfig: Error parsing node line: &quot; + line);</span>
<span class="nc" id="L105">				}</span>
<span class="nc" id="L106">			}</span>
<span class="nc" id="L107">		} catch (IOException e) {</span>
<span class="nc" id="L108">			e.printStackTrace();</span>
<span class="nc" id="L109">		}</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (hasHeaders) lineCount--;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (lineCount &lt; requiredNodeLines) {</span>
<span class="nc" id="L112">			Debug.p(1, this, &quot;The nodes file does not contain enough lines as per configuration file. Required: &quot; + requiredNodeLines + &quot;, Found: &quot; + lineCount + &quot;. Additional nodes to be drawn from alternative sampler.&quot;);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">		} else if (lineCount &gt; requiredNodeLines) {</span>
<span class="nc" id="L114">			Debug.w(this,&quot;Warning: Nodes file contains more lines than required nodes as per configuration file. Required: &quot; + requiredNodeLines + &quot;, Found: &quot; + lineCount);</span>
		}
<span class="nc" id="L116">	}</span>


	// -----------------------------------------------------------------
	// SAMPLING ROUTINES
	// -----------------------------------------------------------------

	/**
	 * Returns the mining interval for a node with the given hash power.
	 * &lt;p&gt;
	 * Delegates to the alternative sampler.
	 * &lt;/p&gt;
	 * @see AbstractNodeSampler#getNextMiningInterval(double)
	 */
	@Override
	public long getNextMiningInterval(double hashPower) {
<span class="nc" id="L132">		return alternativeSampler.getNextMiningInterval(hashPower);</span>
	}

	/**
	 * Returns the next node electric power sample (Watts) from the file,
	 * or from the alternative sampler if the file queue is empty.
	 * @see AbstractNodeSampler#getNextNodeElectricPower()
	 */
	@Override
	public float getNextNodeElectricPower() {
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (!nodeElectricPowers.isEmpty()) {</span>
<span class="nc" id="L143">			return (nodeElectricPowers.poll());</span>
		} else {
<span class="nc" id="L145">			return (alternativeSampler.getNextNodeElectricPower());</span>
		}
	}


	/**
	 * Returns the next node hash power sample from the file,
	 * or from the alternative sampler if the file queue is empty.
	 * @see AbstractNodeSampler#getNextNodeHashPower()
	 */
	@Override
	public float getNextNodeHashPower() {
<span class="nc bnc" id="L157" title="All 2 branches missed.">		if (!nodeHashPowers.isEmpty()) {</span>
<span class="nc" id="L158">			return (nodeHashPowers.poll());</span>
		} else {
<span class="nc" id="L160">			return (alternativeSampler.getNextNodeHashPower());</span>
		}
	}

	/**
	 * Returns the next node electricity cost sample (currency per kWh) from the file,
	 * or from the alternative sampler if the file queue is empty.
	 * @see AbstractNodeSampler#getNextNodeElectricityCost()
	 */
	@Override
	public float getNextNodeElectricityCost() {
<span class="nc bnc" id="L171" title="All 2 branches missed.">		if (!nodeElectricityCosts.isEmpty()) {</span>
<span class="nc" id="L172">			return (nodeElectricityCosts.poll());</span>
		} else {
<span class="nc" id="L174">			return (alternativeSampler.getNextNodeElectricityCost());</span>
		}
	}

	/**
	 * Returns a random node index.
	 * &lt;p&gt;
	 * Delegates to the alternative sampler.
	 * &lt;/p&gt;
	 * @see AbstractNodeSampler#getNextRandomNode(int)
	 */
	@Override
	public int getNextRandomNode(int nNodes) {
<span class="nc" id="L187">		return (alternativeSampler.getNextRandomNode(nNodes));</span>
	}


	// -----------------------------------------------------------------
	// SEED MANAGEMENT
	// -----------------------------------------------------------------

	/**
	 * Updates the seed of the alternative sampler.
	 * &lt;p&gt;
	 * Prints an error if the alternative sampler is not defined.
	 * &lt;/p&gt;
	 */
	public void updateSeed() {
<span class="nc bnc" id="L202" title="All 2 branches missed.">		if (alternativeSampler != null) {</span>
<span class="nc" id="L203">			alternativeSampler.updateSeed();</span>
		} else {
<span class="nc" id="L205">			System.err.print(&quot;Error in update seed: alternativeSampler not defined.&quot;);</span>
		}
<span class="nc" id="L207">	}</span>



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>