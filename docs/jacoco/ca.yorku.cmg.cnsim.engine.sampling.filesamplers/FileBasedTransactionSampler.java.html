<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileBasedTransactionSampler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CNSim Engine</a> &gt; <a href="index.source.html" class="el_package">ca.yorku.cmg.cnsim.engine.sampling.filesamplers</a> &gt; <span class="el_source">FileBasedTransactionSampler.java</span></div><h1>FileBasedTransactionSampler.java</h1><pre class="source lang-java linenums">package ca.yorku.cmg.cnsim.engine.sampling.filesamplers;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.BitSet;
import java.util.LinkedList;
import java.util.Queue;

import ca.yorku.cmg.cnsim.engine.Debug;
import ca.yorku.cmg.cnsim.engine.config.Config;
import ca.yorku.cmg.cnsim.engine.sampling.interfaces.AbstractTransactionSampler;

/**
 * Transaction sampler that reads transaction information from a CSV file.
 * &lt;p&gt;
 * The file is expected to contain transactions with the following columns:
 * &lt;ol&gt;
 *   &lt;li&gt;Transaction ID (ignored)&lt;/li&gt;
 *   &lt;li&gt;Transaction size (long)&lt;/li&gt;
 *   &lt;li&gt;Transaction fee (float)&lt;/li&gt;
 *   &lt;li&gt;Transaction arrival time (long, milliseconds)&lt;/li&gt;
 * &lt;/ol&gt;
 * Optionally, the first line can be a header, which will be skipped.
 * &lt;p&gt;
 * If the file does not contain enough transactions as specified in the configuration
 * property {@code workload.numTransactions}, an optional {@linkplain AbstractTransactionSampler} 
 * can be used to supply additional transaction intervals, sizes, and fees.
 * 
 * @author Sotirios Liaskos
 * @see AbstractTransactionSampler
 */
public class FileBasedTransactionSampler extends AbstractTransactionSampler {

	/** Path to the CSV file containing the transaction workload */
	String transactionsFilePath;

	/** Optional alternative sampler for additional transactions if the file is too short */
<span class="nc" id="L40">	AbstractTransactionSampler alternativeSampler = null;</span>

	/** Number of transactions required according to configuration */
	/** TODO-JIRA: Config validation */
<span class="nc" id="L44">	private int requiredTransactionLines = Config.getPropertyInt(&quot;workload.numTransactions&quot;);</span>

	/** Arrival time of the last transaction (milliseconds) */
<span class="nc" id="L47">	private float lastArrivalTime = 0;</span>

	/** Queue of transaction sizes read from file */
<span class="nc" id="L50">	private Queue&lt;Long&gt; transactionSizes = new LinkedList&lt;&gt;();</span>

	/** Queue of transaction fees read from file */
<span class="nc" id="L53">	private Queue&lt;Float&gt; transactionFeeValues = new LinkedList&lt;&gt;();</span>

	/** Queue of arrival node ids */
<span class="nc" id="L56">	private Queue&lt;Integer&gt; transactionNodeIDs = new LinkedList&lt;&gt;();</span>

	/** Queue of transaction arrival times read from file (milliseconds) */
<span class="nc" id="L59">	private final Queue&lt;Long&gt; transactionArrivalTimes = new LinkedList&lt;&gt;();</span>

	/** ArrayList of conflicting IDs */
<span class="nc" id="L62">	private ArrayList&lt;Integer&gt; conflictingTxs = new ArrayList&lt;&gt;();</span>

	/** ArrayList of conflicting IDs */
<span class="nc" id="L65">	private ArrayList&lt;BitSet&gt; dependencies = new ArrayList&lt;&gt;();</span>


	// -----------------------------------------------------------------
	// CONSTRUCTORS
	// -----------------------------------------------------------------

	/**
	 * Creates a {@linkplain FileBasedTransactionSampler} that reads transactions from a file.
	 * 
	 * @param transactionsFilePath Path to the CSV file containing transaction data
	 */
<span class="nc" id="L77">	public FileBasedTransactionSampler(String transactionsFilePath){</span>
<span class="nc" id="L78">		this.transactionsFilePath = transactionsFilePath;</span>
		try {
<span class="nc" id="L80">			loadTransactionWorkload();</span>
<span class="nc" id="L81">		} catch (Exception e) {</span>
			//TODO-JIRA: unified error reporting
<span class="nc" id="L83">			Debug.e(this, &quot;Error loading workload: &quot; + e.getMessage());</span>
<span class="nc" id="L84">			e.printStackTrace();</span>
<span class="nc" id="L85">			throw new RuntimeException(e);</span>
<span class="nc" id="L86">		}</span>
<span class="nc" id="L87">	}</span>

	/**
	 * Creates a {@linkplain FileBasedTransactionSampler} with an alternative sampler.
	 * &lt;p&gt;
	 * The alternative sampler is used when the file does not contain enough transactions
	 * as specified in configuration.
	 * 
	 * @param transactionsFilePath Path to the CSV file containing transaction data
	 * @param randomSampler        Alternative {@linkplain AbstractTransactionSampler} for missing transactions
	 */
<span class="nc" id="L98">	public FileBasedTransactionSampler(String transactionsFilePath, AbstractTransactionSampler randomSampler) {</span>
<span class="nc" id="L99">		this.alternativeSampler = randomSampler;</span>
<span class="nc" id="L100">		this.transactionsFilePath = transactionsFilePath;</span>
		try {
<span class="nc" id="L102">			loadTransactionWorkload();</span>
<span class="nc" id="L103">		} catch (Exception e) {</span>
			//TODO-JIRA: unified error reporting
<span class="nc" id="L105">			System.err.println(&quot;Error loading workload: &quot; + e.getMessage());</span>
<span class="nc" id="L106">			e.printStackTrace();</span>
<span class="nc" id="L107">		}</span>
<span class="nc" id="L108">	}</span>


	// -----------------------------------------------------------------
	// WORKLOAD LOADING
	// -----------------------------------------------------------------

	/**
	 * Loads the transaction workload from the file.
	 * 
	 * @throws Exception if the file contains fewer transactions than required and no alternative sampler is defined
	 */
	public void loadTransactionWorkload() throws Exception {
<span class="nc" id="L121">		loadTransactionWorkload(true);</span>
<span class="nc" id="L122">	}</span>

	/**
	 * Loads the transaction workload from the file, optionally skipping the header.
	 * 
	 * @param hasHeaders True if the first line is a header and should be skipped
	 * @throws Exception if the file contains fewer transactions than required and no alternative sampler is defined
	 * TODO: incorporate into centralized error and debug reporting.  
	*/
	/*
	public void loadTransactionWorkload(boolean hasHeaders) throws Exception {
		int lineCount = 0;
		String line;
		try (BufferedReader br = new BufferedReader(new FileReader(transactionsFilePath))) {
			while ((line = br.readLine()) != null) {
				lineCount++;
				String[] values = line.split(&quot;,&quot;);
				if (values.length != 4) {
					continue; // Skip lines that don't have exactly 4 values
				}
				if (hasHeaders &amp;&amp; lineCount == 1) {
					continue; // Skip first line
				}
				try {
					transactionSizes.add(Long.parseLong(values[1].trim()));
					transactionFeeValues.add(Float.parseFloat(values[2].trim()));
					transactionArrivalTimes.add(Long.parseLong(values[3].trim()));
				} catch (NumberFormatException e) {
					System.err.println(&quot;Error parsing transaction line: &quot; + line);
				}
			}
		} catch (IOException e) {
			Debug.e(this,&quot;Error loading workload: no such file or directory.&quot;);
			throw e;
		}
		if (hasHeaders) lineCount--;
		if (lineCount &lt; requiredTransactionLines) {
			if (alternativeSampler == null) {
				throw new Exception(&quot;The transaction file does not contain enough lines as per configuration file. Required: &quot; + requiredTransactionLines + &quot;, Found: &quot; + lineCount + &quot;. Define alternative sampler for the additional intervals or update config file.&quot;);
			} else {
				Debug.p(1,this,&quot;The transaction file does not contain enough lines as per configuration file. Required: &quot; + requiredTransactionLines + &quot;, Found: &quot; + lineCount + &quot;. Additional arrrivals to be drawn from alternative sampler.&quot;);
			}
		} else if (lineCount &gt; requiredTransactionLines) {
			Debug.w(this,&quot;Transaction file contains more lines than required transactions as per configuration file. Required: &quot;	+ requiredTransactionLines + &quot;, Found: &quot; + lineCount);
		}
	}
	 */



	public void loadTransactionWorkload(boolean hasHeaders) throws Exception {
<span class="nc" id="L173">		int lineCount = 0;</span>
		String line;
<span class="nc" id="L175">		try (BufferedReader br = new BufferedReader(new FileReader(transactionsFilePath))) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">			while ((line = br.readLine()) != null) {</span>
<span class="nc" id="L177">				lineCount++;</span>
<span class="nc" id="L178">				String[] values = line.split(&quot;,&quot;);</span>

				// Skip lines that don't have at least 4 columns
<span class="nc bnc" id="L181" title="All 2 branches missed.">				if (values.length &lt; 5) {</span>
<span class="nc" id="L182">					continue;</span>
				}

				// Skip first line if headers
<span class="nc bnc" id="L186" title="All 4 branches missed.">				if (hasHeaders &amp;&amp; lineCount == 1) {</span>
<span class="nc" id="L187">					continue;</span>
				}

				try {
<span class="nc" id="L191">					transactionSizes.add(Long.parseLong(values[1].trim()));</span>
<span class="nc" id="L192">					transactionFeeValues.add(Float.parseFloat(values[2].trim()));</span>
<span class="nc" id="L193">					transactionNodeIDs.add(Integer.parseInt(values[3].trim()));</span>
<span class="nc" id="L194">					transactionArrivalTimes.add(Long.parseLong(values[4].trim()));</span>

<span class="nc bnc" id="L196" title="All 3 branches missed.">					switch (values.length) {</span>
					case 7: //has both conflicting Tx and dependencies
<span class="nc" id="L198">						dependencies.add(parseToBitSet(values[6].trim()));</span>
					case 6: //has conflicting Tx
						try {
<span class="nc" id="L201">							conflictingTxs.add(Integer.parseInt(values[5].trim()));</span>
<span class="nc" id="L202">						} catch (NumberFormatException e) {</span>
<span class="nc" id="L203">							System.err.println(&quot;Error parsing conflictingTx for line: &quot; + line + </span>
									&quot; â€” storing as -1&quot;);
<span class="nc" id="L205">							conflictingTxs.add(-1); // fallback if parsing fails</span>
<span class="nc" id="L206">						}</span>
<span class="nc" id="L207">						break;</span>
					default:
<span class="nc" id="L209">						conflictingTxs.add(-1);</span>
					}
					
<span class="nc" id="L212">				} catch (NumberFormatException e) {</span>
<span class="nc" id="L213">					Debug.e(&quot;Error parsing transaction line: &quot; + line);</span>
<span class="nc" id="L214">					Debug.e(&quot;1: &quot; + Long.parseLong(values[1].trim()));</span>
<span class="nc" id="L215">					Debug.e(&quot;2: &quot; + Float.parseFloat(values[1].trim()));</span>
<span class="nc" id="L216">					Debug.e(&quot;3: &quot; + Integer.parseInt(values[3].trim()));</span>
<span class="nc" id="L217">					Debug.e(&quot;4: &quot; + Long.parseLong(values[4].trim()));</span>
<span class="nc" id="L218">					System.exit(-1);</span>
<span class="nc" id="L219">				}</span>
<span class="nc" id="L220">			}</span>
<span class="nc" id="L221">		} catch (IOException e) {</span>
<span class="nc" id="L222">			Debug.e(this,&quot;Error loading workload: no such file or directory.&quot;);</span>
<span class="nc" id="L223">			throw e;</span>
<span class="nc" id="L224">		}</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">		if (hasHeaders) lineCount--;</span>

<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (lineCount &lt; requiredTransactionLines) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">			if (alternativeSampler == null) {</span>
<span class="nc" id="L230">				throw new Exception(&quot;The transaction file does not contain enough lines as per configuration file. Required: &quot; + requiredTransactionLines + &quot;, Found: &quot; + lineCount + &quot;. Define alternative sampler for the additional intervals or update config file.&quot;);</span>
			} else {
<span class="nc" id="L232">				Debug.p(1,this,&quot;The transaction file does not contain enough lines as per configuration file. Required: &quot; + requiredTransactionLines + &quot;, Found: &quot; + lineCount + &quot;. Additional arrivals to be drawn from alternative sampler.&quot;);</span>
			}
<span class="nc bnc" id="L234" title="All 2 branches missed.">		} else if (lineCount &gt; requiredTransactionLines) {</span>
<span class="nc" id="L235">			Debug.w(this,&quot;Transaction file contains more lines than required transactions as per configuration file. Required: &quot; + requiredTransactionLines + &quot;, Found: &quot; + lineCount);</span>
		}
<span class="nc" id="L237">	}</span>




	// -----------------------------------------------------------------
	// SAMPLING ROUTINES
	// -----------------------------------------------------------------

	/**
	 * Returns the next transaction arrival interval in milliseconds.
	 * &lt;p&gt;
	 * Pulls from the file queues; if the file is exhausted, uses the alternative sampler.
	 * &lt;/p&gt;
	 * 
	 * @return interval until the next transaction in milliseconds
	 * @throws Exception if the file is exhausted and no alternative sampler is defined
	 */
	@Override
	public float getNextTransactionArrivalInterval() throws Exception {
		float arrivalTime;
		float interval;

<span class="nc bnc" id="L260" title="All 2 branches missed.">		if (!transactionArrivalTimes.isEmpty()) {</span>
<span class="nc" id="L261">			arrivalTime = transactionArrivalTimes.poll();</span>
<span class="nc" id="L262">			interval = arrivalTime - lastArrivalTime;</span>
<span class="nc" id="L263">			lastArrivalTime = arrivalTime;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">		} else if (alternativeSampler != null) {</span>
<span class="nc" id="L265">			interval = alternativeSampler.getNextTransactionArrivalInterval();</span>
		} else {
<span class="nc" id="L267">			Debug.e(this,&quot;getNextTransactionArrivalInterval(): Transaction file has less transactions than specified in configuration file. Alternative Sampler not specified.&quot;);</span>
<span class="nc" id="L268">			throw new Exception(&quot;Transaction file has less transactions than specified in configuration file. Alternative Sampler not specified.&quot;);</span>
		}
<span class="nc" id="L270">		return (interval); </span>
	}

	/**
	 * Returns the next transaction fee value.
	 * &lt;p&gt;
	 * Pulls from the file queues; if the file is exhausted, uses the alternative sampler.
	 * &lt;/p&gt;
	 * 
	 * @return transaction fee value
	 * @throws Exception if the file is exhausted and no alternative sampler is defined
	 */
	@Override
	public float getNextTransactionFeeValue() throws Exception {
<span class="nc bnc" id="L284" title="All 2 branches missed.">		if (!transactionFeeValues.isEmpty()) {</span>
<span class="nc" id="L285">			return(transactionFeeValues.poll());</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">		} else if (alternativeSampler != null) {</span>
<span class="nc" id="L287">			return(alternativeSampler.getNextTransactionFeeValue());</span>
		} else {
<span class="nc" id="L289">			Debug.e(this,&quot;getNextTransactionFeeValue(): Transaction file has less transactions than specified in configuration file. Alternative Sampler not specified.&quot;);</span>
<span class="nc" id="L290">			throw new Exception(&quot;Transaction file has less transactions than specified in configuration file. Alternative Sampler not specified.&quot;);</span>
		}
	}

	/** 
	 * Returns the next transaction size.
	 * &lt;p&gt;
	 * Pulls from the file queues; if the file is exhausted, uses the alternative sampler.
	 * &lt;/p&gt;
	 * 
	 * @return transaction size
	 * @throws Exception if the file is exhausted and no alternative sampler is defined
	 */
	@Override
	public long getNextTransactionSize() throws Exception {
<span class="nc bnc" id="L305" title="All 2 branches missed.">		if (!transactionSizes.isEmpty()) {</span>
<span class="nc" id="L306">			return(transactionSizes.poll());</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">		} else if (alternativeSampler != null) {</span>
<span class="nc" id="L308">			return(alternativeSampler.getNextTransactionSize());</span>
		} else {
<span class="nc" id="L310">			Debug.e(this,&quot;getNextTransactionSize(): Transaction file has less transactions than specified in configuration file. Alternative Sampler not specified.&quot;);</span>
<span class="nc" id="L311">			throw new Exception(&quot;Transaction file has less transactions than specified in configuration file. Alternative Sampler not specified.&quot;);</span>
		}
	}



	/** 
	 * Returns the next transaction size.
	 * &lt;p&gt;
	 * Pulls from the file queues; if the file is exhausted, uses the alternative sampler.
	 * &lt;/p&gt;
	 * 
	 * @return transaction size
	 * @throws Exception if the file is exhausted and no alternative sampler is defined
	 */
	@Override
	public int getArrivalNode() {
<span class="nc bnc" id="L328" title="All 2 branches missed.">		if (!transactionNodeIDs.isEmpty()) {</span>
<span class="nc" id="L329">			return(transactionNodeIDs.poll());</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">		} else if (alternativeSampler != null) {</span>
<span class="nc" id="L331">			return(alternativeSampler.getArrivalNode());</span>
		} else {
<span class="nc" id="L333">			Debug.e(this,&quot;getArrivalNode(): Transaction file has less transactions than specified in configuration file. Alternative Sampler not specified.&quot;);</span>
<span class="nc" id="L334">			throw new IllegalStateException(&quot;Transaction file has less transactions than specified in configuration file. Alternative Sampler not specified.&quot;);</span>
		}
	}



	/**
	 * Returns a uniformly sampled integer in the given range.
	 * &lt;p&gt;
	 * Delegates to the alternative sampler.
	 * &lt;/p&gt;
	 */
	@Override
	public int getRandomNum(int min, int max) {
<span class="nc" id="L348">		return(alternativeSampler.getRandomNum(min, max));</span>
	}


	@Override
	public int getConflict(int id, int N, double alpha, double likelihood) {
		int conf;
<span class="nc bnc" id="L355" title="All 2 branches missed.">		if (id &lt;= conflictingTxs.size()) {</span>
<span class="nc" id="L356">			conf = conflictingTxs.get(id-1);</span>
			//System.err.println(&quot;File conflict for  &quot; + id + &quot; is &quot; + conf);
		} else {
<span class="nc" id="L359">			conf = alternativeSampler.getConflict(id, N, alpha, likelihood);</span>
			//System.err.println(&quot;Rand conflict for  &quot; + id + &quot; is &quot; + conf);
		}
<span class="nc" id="L362">		return (conf);</span>
	}

	@Override
	public BitSet randomDependencies(int id, boolean mandatory, float dispersion, int countMean, float countSD) {
<span class="nc bnc" id="L367" title="All 2 branches missed.">		if (id &lt;= dependencies.size()) {</span>
<span class="nc" id="L368">			return(dependencies.get(id-1));</span>
		} else {
<span class="nc" id="L370">			return(alternativeSampler.randomDependencies(id, mandatory, dispersion, countMean, countSD));</span>
		}
	}


	// -----------------------------------------------------------------
	// SEED MANAGEMENT
	// -----------------------------------------------------------------


	/**
	 * Updates the seed in the alternative sampler.
	 * @see ca.yorku.cmg.cnsim.engine.sampling.interfaces.IMultiSowable#updateSeed()
	 * @see ca.yorku.cmg.cnsim.engine.sampling.standardsamplers.StandardTransactionSampler#updateSeed()

	 */
	@Override
	public void updateSeed() {
<span class="nc" id="L388">		alternativeSampler.updateSeed();</span>
<span class="nc" id="L389">	}</span>

	/**
	 * Returns the transaction ID at which the seed will change.
	 * &lt;p&gt;
	 * Delegates to the alternative sampler.
	 * &lt;/p&gt;
	 */
	@Override
	public long getSeedChangeTx() {
<span class="nc" id="L399">		return(alternativeSampler.getSeedChangeTx());</span>
	}

	/**
	 * Returns whether seed updates are enabled.
	 * &lt;p&gt;
	 * Delegates to the alternative sampler.
	 * &lt;/p&gt;
	 */
	@Override
	public boolean seedUpdateEnabled() {
<span class="nc" id="L410">		return(alternativeSampler.seedUpdateEnabled());</span>
	}
	
	
	
	
	// -----------------------------------------------------------------
	// HELPER
	// -----------------------------------------------------------------

	public static BitSet parseToBitSet(String s) {
<span class="nc bnc" id="L421" title="All 2 branches missed.">	    if (s == null) {</span>
<span class="nc" id="L422">	        throw new IllegalArgumentException(&quot;Input cannot be null&quot;);</span>
	    }

<span class="nc" id="L425">	    String trimmed = s.trim();</span>

	    // Special case: &quot;-1&quot; means empty bitset
<span class="nc bnc" id="L428" title="All 2 branches missed.">	    if (trimmed.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L429">	        return new BitSet();</span>
	    }

	    // Must start with '{' and end with '}'
<span class="nc bnc" id="L433" title="All 4 branches missed.">	    if (!trimmed.startsWith(&quot;{&quot;) || !trimmed.endsWith(&quot;}&quot;)) {</span>
<span class="nc" id="L434">	        throw new IllegalArgumentException(&quot;Input must be of the form {1,2,3} or -1&quot;);</span>
	    }

	    // Extract inner content
<span class="nc" id="L438">	    String content = trimmed.substring(1, trimmed.length() - 1).trim();</span>

	    // Empty braces &quot;{}&quot; are not allowed
<span class="nc bnc" id="L441" title="All 2 branches missed.">	    if (content.isEmpty()) {</span>
<span class="nc" id="L442">	        throw new IllegalArgumentException(&quot;Empty braces {} are not permitted; use -1 for empty&quot;);</span>
	    }

<span class="nc" id="L445">	    BitSet bitSet = new BitSet();</span>

<span class="nc" id="L447">	    String[] parts = content.split(&quot;;&quot;);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">	    for (String part : parts) {</span>
<span class="nc" id="L449">	        String p = part.trim();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">	        if (p.isEmpty()) {</span>
<span class="nc" id="L451">	            throw new IllegalArgumentException(&quot;Empty entry inside braces: &quot; + s);</span>
	        }
	        int index;
	        try {
<span class="nc" id="L455">	            index = Integer.parseInt(p);</span>
<span class="nc" id="L456">	        } catch (NumberFormatException e) {</span>
<span class="nc" id="L457">	            throw new IllegalArgumentException(&quot;Invalid integer value: &quot; + p);</span>
<span class="nc" id="L458">	        }</span>

<span class="nc bnc" id="L460" title="All 2 branches missed.">	        if (index &lt; 0) {</span>
<span class="nc" id="L461">	            throw new IllegalArgumentException(&quot;Negative bit index: &quot; + index);</span>
	        }

<span class="nc" id="L464">	        bitSet.set(index);</span>
	    }

<span class="nc" id="L467">	    return bitSet;</span>
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>